name: Hikari Novel Flutter Windows Build
on:
  workflow_dispatch:  # 仅手动触发

jobs:
  build-windows:
    runs-on: windows-2022
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Flutter 3.19.0
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.7'
          channel: 'stable'
          cache: true

      - name: Verify Flutter Environment
        run: flutter doctor -v

      - name: Unzip Source Code (if zip exists)
        run: |
          $zipFiles = Get-ChildItem -Path . -Filter "*.zip"
          if ($zipFiles.Count -gt 0) {
              Expand-Archive -Path $zipFiles[0].FullName -DestinationPath ./source -Force
              $sourceDir = Get-ChildItem -Path ./source -Directory | Select-Object -First 1
              if ($sourceDir) {
                  Copy-Item -Path "$($sourceDir.FullName)\*" -Destination . -Recurse -Force
              }
              Remove-Item -Path ./source -Recurse -Force
          }

      - name: Generate Windows Build Files
        run: flutter create --platforms windows .

      - name: Install & Upgrade Dependencies
        run: |
          flutter pub add path_provider_windows
          flutter pub add url_launcher_windows
          flutter pub upgrade
          flutter pub get
          flutter precache --windows

      - name: Clean Project
        run: flutter clean

      - name: Build Windows Release EXE
        run: |
          flutter build windows --release --verbose
          # 修复：使用 PowerShell 正确的递归目录查看命令
          Get-ChildItem -Path ./build -Recurse | Select-Object FullName
          Get-ChildItem -Path ./windows -Recurse | Select-Object FullName

      - name: Upload Windows EXE Artifact
        uses: actions/upload-artifact@v4
        with:
          name: hikari-novel-windows-exe
          # 修复：使用正确的产物路径（x64 目录）
          path: |
            build/windows/x64/runner/Release/**/*
          if-no-files-found: warn
