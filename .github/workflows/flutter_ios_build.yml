name: Flutter iOS Build IPA (Force Compile)
on:
  workflow_dispatch: # 手动触发编译

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 直接使用环境内置Flutter（放弃版本替换）
        run: |
          # 打印当前环境所有Flutter/Dart版本
          which flutter
          which dart
          flutter --version
          dart --version
          # 强制接受所有协议
          yes | flutter doctor --android-licenses > /dev/null 2>&1

      - name: 强制安装项目依赖（忽略版本警告）
        run: flutter pub get --no-version-check

      - name: 安装iOS CocoaPods依赖
        run: |
          cd ios
          pod install --repo-update
          cd ..

      - name: 强制构建iOS无签名Release包
        run: flutter build ios --release --no-codesign --no-simulator --ignore-version-check

      - name: 打包成无签名IPA
        run: |
          mkdir -p Payload
          # 兼容不同编译产物路径
          if [ -d "build/ios/iphoneos/Runner.app" ]; then
            cp -r build/ios/iphoneos/Runner.app Payload/
          elif [ -d "build/ios/archive/Runner.xcarchive/Products/Applications/Runner.app" ]; then
            cp -r build/ios/archive/Runner.xcarchive/Products/Applications/Runner.app Payload/
          else
            echo "⚠️ 未找到Runner.app，尝试查找所有.app文件"
            find build -name "*.app" -exec cp -r {} Payload/ \;
          fi
          zip -r hikari_novel.ipa Payload/
          rm -rf Payload

      - name: 上传IPA产物
        uses: actions/upload-artifact@v4
        with:
          name: hikari-novel-ios-ipa
          path: hikari_novel.ipa
