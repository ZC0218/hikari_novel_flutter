name: Windows Build & Code Check
on:
  push:
    branches: [ main ]  # 推送代码时触发
  pull_request:
    branches: [ main ]  # PR 时触发
  workflow_dispatch:    # 手动触发（推荐先手动测试）

jobs:
  build-windows:
    runs-on: windows-2022  # GitHub 提供的 Windows 虚拟机（带 VS2022）
    steps:
      # 步骤1：检出代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 步骤2：安装 Flutter SDK（指定稳定版，避免版本兼容问题）
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.x'  # 适配 Windows 编译的稳定版
          channel: 'stable'

      # 步骤3：flutter doctor 检查环境（排错用）
      - name: Flutter Doctor
        run: flutter doctor -v

      # 步骤4：代码检查（分析语法/静态错误）
      - name: Code Analysis
        run: flutter analyze --no-fatal-warnings  # 警告不终止流程，错误会终止

      # 步骤5：获取项目依赖（解决 pub get 失败问题）
      - name: Get Dependencies
        run: |
          flutter pub get
          # 若依赖有原生插件，执行 Windows 构建前的预处理
          flutter precache --windows

      # 步骤6：清理缓存（避免编译残留）
      - name: Clean Project
        run: flutter clean

      # 步骤7：编译 Windows Release 版 EXE
      - name: Build Windows Release
        run: flutter build windows --release --verbose  # --verbose 输出详细日志，便于排错

      # 步骤8：上传编译产物（供下载）
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: build/windows/runner/Release/  # 编译后的 EXE 及依赖库目录
